<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OCM BTC Price</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      margin: 0;
      background-color: #18181D;
      font-family: Inter, sans-serif;
      color: white;
    }
    #chart-container {
      position: relative;
      width: 100vw;
      height: 80vh;
      margin: 0;
      background-color: #18181D;
    }
    #logo-front {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      opacity: 0.85;
      pointer-events: none;
      width: 70%;
      height: auto;
      z-index: 10;
      mix-blend-mode: lighten;
    }
    #chart {
      position: relative;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
  </style>
</head>
<body>
  <div id="chart-container">
    <img id="logo-front" src="logo.png" alt="Logo Overlay" />
    <div id="chart"></div>
  </div>

  <script>
    function buildTraces(priceData) {
      return [
        {
          x: priceData.map(d => d.date),
          y: priceData.map(d => d.price),
          type: 'scatter',
          mode: 'lines',
          name: 'BTC Price',
          line: { color: 'white', width: 1 },
          hovertemplate: '<b>Price:</b> $%{y:,.0f}<extra></extra>'
        }
      ];
    }

    fetch("/api/derived/price.js")
      .then(r => r.json())
      .then(priceResult => {
        const cutoffDate = new Date('2013-02-01');
        const priceData = priceResult.data.filter(d => new Date(d.date) >= cutoffDate);
        const lastDate = priceData[priceData.length - 1].date;

        const layout = {
          paper_bgcolor: '#18181D',
          plot_bgcolor: '#18181D',
          font: { color: 'white' },
          margin: { t: 20, b: 5 },
          hovermode: 'x unified',
          xaxis: {
            type: 'date',
            range: ['2013-02-01', lastDate],
            showspikes: true,
            spikemode: 'across',
            spikecolor: 'white',
            spikethickness: 1
          },
          yaxis: {
            title: 'Price (USD)',
            type: 'log',
            tickprefix: '$',
            showline: false
          },
          legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: -0.1 }
        };

        const traces = buildTraces(priceData);
        Plotly.newPlot('chart', traces, layout, { responsive: true }).then(() => {
          const logo = document.getElementById('logo-front');
          const downloadBtn = document.querySelector('.modebar-btn[data-title="Download plot as a png"]');

          if (downloadBtn) {
            downloadBtn.addEventListener('click', () => {
              logo.style.display = 'none';
              setTimeout(() => {
                Plotly.downloadImage('chart', {
                  format: 'png',
                  width: 1600,
                  height: 900,
                  filename: 'OCM-Price'
                }).then(() => {
                  logo.style.display = '';
                });
              }, 300);
            });
          }
        });
      })
      .catch(err => {
        console.error(err);
        document.getElementById('chart').innerHTML =
          `<p style="color:red; text-align:center;">Failed to load data.</p>`;
      });
  </script>
</body>
</html>
